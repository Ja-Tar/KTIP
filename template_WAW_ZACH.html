<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wyświetlacz / Display</title>
    <link rel="stylesheet" href="template_WAW_ZACH.css">
</head>

<body>
    <script>
        window.addEventListener('resize', scaleDisplay);
        document.addEventListener('DOMContentLoaded', function () {
            replaceTemplateValues();
            canvasSetup();
            scaleDisplay();
        });

        function scaleDisplay() {
            var display = document.getElementById('display');
            var scaleFactor = window.innerWidth / 700;

            display.style.transform = 'scale(' + scaleFactor + ')';
            display.style.transformOrigin = 'top left';

            var all_canvas = document.getElementsByClassName('scrollCanvas');
            for (var i = 0; i < all_canvas.length; i++) {
                all_canvas[i].style.transform = 'scale(' + 1 / scaleFactor + ')';
                all_canvas[i].style.transformOrigin = 'top left';
            }
        }

        function replaceTemplateValues() {
            var time = document.getElementById('time');
            var trainNumber = document.getElementById('train_number');
            var destination = document.getElementById('destination');
            var viaStations = document.getElementById('via_stations');
            var operator = document.getElementById('operator');
            var infoBar = document.getElementById('info_bar');

            var urlParams = new URLSearchParams(window.location.search);

            if (!urlParams.has('time') || !urlParams.has('train_number') || !urlParams.has('destination') || !urlParams.has('via_stations') || !urlParams.has('operator') || !urlParams.has('info_bar')) {
                return;
            }

            time.innerHTML = urlParams.get('time');
            trainNumber.innerHTML = urlParams.get('train_number');
            destination.innerHTML = urlParams.get('destination');
            destination.setAttribute('data-scroll-text', urlParams.get('destination'));
            viaStations.innerHTML = urlParams.get('via_stations');
            viaStations.setAttribute('data-scroll-text', urlParams.get('via_stations'));
            operator.innerHTML = urlParams.get('operator');

            if (urlParams.has('info_bar') && urlParams.get('info_bar') != '') {
                infoBar.innerHTML = urlParams.get('info_bar');
                infoBar.setAttribute('data-scroll-text', urlParams.get('info_bar'));
            } else {
                infoBar.parentElement.style.display = "none"
            }
        }

        function canvasSetup() {
            const canvases = document.querySelectorAll('.scrollCanvas');

            canvases.forEach(canvas => {
                const ctx = canvas.getContext('2d');

                canvas.width = window.innerWidth;
                canvas.height = 40; // Adjust height as needed

                // Text properties
                let scrollText = canvas.getAttribute('text-scroll') || "Default scrolling text";
                const fontSize = parseInt(canvas.getAttribute('text-size')) || 30; // Default font size is 30
                const fontFamily = "Arial";
                const letterSpacing = 50; // Space between text instances

                // Calculate text width for animation
                ctx.font = `${fontSize}px ${fontFamily}`;
                const textWidth = ctx.measureText(scrollText).width;

                // Calculate number of text instances needed to fill the canvas width
                const numInstances = Math.ceil(canvas.width / (textWidth + letterSpacing));

                // Initialize text positions
                let textPositions = [];
                for (let i = 0; i < numInstances; i++) {
                    textPositions.push(i * (textWidth + letterSpacing));
                }

                // Animation variables
                let scrollSpeed = 1; // Adjust scrolling speed
                let scrollPosition = 0;

                // Animation function
                function animate() {
                    // Clear canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // Draw text instances
                    ctx.fillStyle = 'white';
                    ctx.font = `${fontSize}px ${fontFamily}`;

                    for (let i = 0; i < textPositions.length; i++) {
                        const x = textPositions[i] - scrollPosition;
                        ctx.fillText(scrollText, x, canvas.height - 10);
                    }

                    // Move text positions
                    scrollPosition += scrollSpeed;
                    if (scrollPosition > (textWidth + letterSpacing)) {
                        scrollPosition = 0;
                    }

                    // Request next frame
                    requestAnimationFrame(animate);
                }

                // Start animation
                animate();
            });
        }

    </script>
    <div id="display_box">
        <li id="display">
            <ul id="row1" class="row">
                <div id="time">00:00</div>
                <div id="delay_box" style="display: none;">
                    <div class="label">Opóźniony / Delayed:</div>
                    <div id="delay"></div> <!-- TODO -->
                </div>
                <div id="train_number_box">
                    <div class="label">Numer / Number:</div>
                    <div id="train_number">{TRAIN_NUMBER}</div>
                </div>
            </ul>
            <ul id="row2" class="row">
                <div id="destination"><canvas class="scrollCanvas" id="destination_canvas"
                        text-scroll="{DESTINATION_CANVAS}" text-size="40"></canvas></div>
            </ul>
            <ul id="row3" class="row">
                <div id="via_stations_box">
                    <div class="label">Stacje pośrednie / Via stations:</div>
                    <div id="via_stations"><canvas class="scrollCanvas" id="via_stations_canvas"
                            text-scroll="{VIA_STATIONS_CANVAS}"></canvas></div>
                </div>
            </ul>
            <ul id="row4" class="row">
                <div id="operator_box">
                    <div class="label">Przewoźnik / Operator:</div>
                    <div id="operator">{OPERATOR}</div>
                </div>
            </ul>
            <ul id="info_bar_box" class="row">
                <div id="info_bar"><canvas class="scrollCanvas" id="info_bar_canvas"
                        text-scroll="{INFO_BAR_CANVAS}"></canvas></div>
            </ul>
        </li>
    </div>
    <!-- The ids are used for replacing the template value -->
</body>

</html>